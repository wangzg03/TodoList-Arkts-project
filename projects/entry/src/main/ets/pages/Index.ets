// å®šä¹‰æ¥å£
interface StorageKeysType {
  TODOS: string;
  HEALTH_ITEMS: string;
  HEALTH_STREAK_DAYS: string;
  LAST_RESET_DATE: string;
  HAS_COMPLETED_TODAY: string;
  NEXT_ID: string;
}

// å®šä¹‰å­˜å‚¨é”®
const StorageKeys: StorageKeysType = {
  TODOS: 'todos',
  HEALTH_ITEMS: 'healthReminderItems',
  HEALTH_STREAK_DAYS: 'healthStreakDays',
  LAST_RESET_DATE: 'lastResetDate',
  HAS_COMPLETED_TODAY: 'hasCompletedToday',
  NEXT_ID: 'nextId',
};

// å®šä¹‰ä»»åŠ¡ç»“æ„
interface TodoItem {
  id: number;
  text: string;
  completed: boolean;
  priority: number;
  order: number;
  createdAt: number;
  completedAt: number;
}

interface HealthReminderItem {
  id: number;
  name: string;
  description: string;
  selected: boolean;
  uiSelected: boolean;
}

@Entry
@Component
struct TodoListApp {
  // ä½¿ç”¨LocalStorageLinkè¿æ¥å­˜å‚¨
  @LocalStorageLink(StorageKeys.TODOS) todos: TodoItem[] = [];
  @LocalStorageLink(StorageKeys.HEALTH_ITEMS) healthReminderItems: HealthReminderItem[] = [];
  @LocalStorageLink(StorageKeys.HEALTH_STREAK_DAYS) healthStreakDays: number = 0;
  @LocalStorageLink(StorageKeys.LAST_RESET_DATE) lastResetDate: number = 0;
  @LocalStorageLink(StorageKeys.HAS_COMPLETED_TODAY) hasCompletedToday: boolean = false;
  @LocalStorageLink(StorageKeys.NEXT_ID) nextId: number = 4;

  // éæŒä¹…åŒ–çŠ¶æ€
  @State newTodoText: string = '';
  @State newTodoPriority: number = 2;
  @State draggingIndex: number = -1;
  @State hoverIndex: number = -1;
  @State currentView: 'all' | 'completed' | 'uncompleted' = 'all';
  @State healthSuccessMessage: string = '';
  @State motivationalMessages: string[] = [
    'è®¾å®šç›®æ ‡ï¼Œè¿½é€æ¢¦æƒ³ï¼',
    'æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹ï¼',
    'ä½ æ¯”è‡ªå·±æƒ³è±¡çš„æ›´å¼ºå¤§ï¼',
    'ä»Šå¤©çš„åŠªåŠ›æ˜¯æ˜å¤©çš„æ”¶è·ï¼',
    'åšæŒå°±æ˜¯èƒœåˆ©ï¼',
    'è®©ä»Šå¤©çš„ä½ æ¯”æ˜¨å¤©æ›´å¥½ï¼',
    'å°æ­¥å¿«è·‘ï¼ŒæŒç»­è¿›æ­¥ï¼',
    'æˆé•¿ä»è¡ŒåŠ¨å¼€å§‹ï¼',
    'æ¯ä¸€æ¬¡å°è¯•éƒ½å€¼å¾—éª„å‚²ï¼',
    'ç›¸ä¿¡è‡ªå·±ï¼Œä½ èƒ½åšåˆ°ï¼',
    'æˆåŠŸå±äºåšæŒä¸æ‡ˆçš„äººï¼',
    'æ¢¦æƒ³åœ¨å‰æ–¹ç­‰ä½ ï¼'
  ];
  @State emptyStateMotivation: string = '';
  @State healthForceUpdateKey: number = 0;
  @State todosForceUpdateKey: number = 0;
  private healthResetTimer: number = 0;
  private storage: LocalStorage = new LocalStorage();

  getPriorityColor(priority: number): string {
    switch (priority) {
      case 1: return '#FF6B6B';
      case 2: return '#FFA726';
      case 3: return '#4CAF50';
      default: return '#757575';
    }
  }

  getPriorityText(priority: number): string {
    switch (priority) {
      case 1: return 'é«˜';
      case 2: return 'ä¸­';
      case 3: return 'ä½';
      default: return 'ä¸­';
    }
  }

  getImageResource(name: string): Resource {
    switch (name) {
      case 'å–æ°´': return $r('app.media.water');
      case 'è¿åŠ¨': return $r('app.media.sports');
      case 'é¥®é£Ÿ': return $r('app.media.eat');
      case 'ä¼‘æ¯': return $r('app.media.sleep');
      case 'å­¦ä¹ ': return $r('app.media.study');
      default: return $r('app.media.water');
    }
  }

  addTodo(): void {
    const trimmedText = this.newTodoText.trim();
    if (trimmedText === '') return;

    const newTodo: TodoItem = {
      id: this.nextId,
      text: trimmedText,
      completed: false,
      priority: this.newTodoPriority,
      order: this.todos.length + 1,
      createdAt: Date.now(),
      completedAt: 0
    };

    this.todos.push(newTodo);
    this.nextId = this.nextId + 1;
    this.newTodoText = '';
    this.sortTodos();
    this.todosForceUpdateKey = this.todosForceUpdateKey + 1;
  }

  deleteTodo(id: number): void {
    const newTodos: TodoItem[] = [];
    for (let i = 0; i < this.todos.length; i++) {
      if (this.todos[i].id !== id) {
        newTodos.push(this.todos[i]);
      }
    }
    this.todos = newTodos;
    this.reorderTodos();
    this.todosForceUpdateKey = this.todosForceUpdateKey + 1;
  }

  toggleComplete(id: number): void {
    const newTodos: TodoItem[] = [];
    for (let i = 0; i < this.todos.length; i++) {
      if (this.todos[i].id === id) {
        const isNowCompleted = !this.todos[i].completed;
        const updatedTodo: TodoItem = {
          id: this.todos[i].id,
          text: this.todos[i].text,
          completed: isNowCompleted,
          priority: this.todos[i].priority,
          order: this.todos[i].order,
          createdAt: this.todos[i].createdAt,
          completedAt: isNowCompleted ? Date.now() : 0
        };
        newTodos.push(updatedTodo);
      } else {
        newTodos.push(this.todos[i]);
      }
    }
    this.todos = newTodos;
    this.sortTodos();
    this.todosForceUpdateKey = this.todosForceUpdateKey + 1;
  }

  toggleHealthReminderItem(index: number): void {
    console.log(`=== çœŸæ­£åˆ†ç¦»ç­–ç•¥ ===`);

    const newHealthItems: HealthReminderItem[] = [];
    for (let i = 0; i < this.healthReminderItems.length; i++) {
      if (i === index) {
        const newItem: HealthReminderItem = {
          id: this.healthReminderItems[i].id,
          name: this.healthReminderItems[i].name,
          description: this.healthReminderItems[i].description,
          selected: !this.healthReminderItems[i].selected,
          uiSelected: this.healthReminderItems[i].uiSelected
        };
        newHealthItems.push(newItem);
      } else {
        const sameItem: HealthReminderItem = {
          id: this.healthReminderItems[i].id,
          name: this.healthReminderItems[i].name,
          description: this.healthReminderItems[i].description,
          selected: this.healthReminderItems[i].selected,
          uiSelected: this.healthReminderItems[i].uiSelected
        };
        newHealthItems.push(sameItem);
      }
    }
    this.healthReminderItems = newHealthItems;

    setTimeout(() => {
      this.healthReminderItems[index].uiSelected = !this.healthReminderItems[index].uiSelected;
      this.healthForceUpdateKey = this.healthForceUpdateKey + 1;
      console.log(`UIçŠ¶æ€å·²æ›´æ–°: ${this.healthReminderItems[index].name} = ${this.healthReminderItems[index].uiSelected}`);
    }, 10);

    this.checkAllHealthGoalsCompleted();
  }

  toggleAllHealthReminders(): void {
    console.log('=== ä¸€é”®åˆ‡æ¢ - çœŸæ­£åˆ†ç¦»ç­–ç•¥ ===');

    let allSelected = true;
    for (let i = 0; i < this.healthReminderItems.length; i++) {
      if (!this.healthReminderItems[i].selected) {
        allSelected = false;
        break;
      }
    }

    const newHealthItems: HealthReminderItem[] = [];
    for (let i = 0; i < this.healthReminderItems.length; i++) {
      const newItem: HealthReminderItem = {
        id: this.healthReminderItems[i].id,
        name: this.healthReminderItems[i].name,
        description: this.healthReminderItems[i].description,
        selected: !allSelected,
        uiSelected: this.healthReminderItems[i].uiSelected
      };
      newHealthItems.push(newItem);
    }
    this.healthReminderItems = newHealthItems;

    setTimeout(() => {
      for (let i = 0; i < this.healthReminderItems.length; i++) {
        this.healthReminderItems[i].uiSelected = !allSelected;
      }
      this.healthForceUpdateKey = this.healthForceUpdateKey + 1;
      console.log('æ‰€æœ‰UIçŠ¶æ€å·²æ›´æ–°');
    }, 10);

    this.checkAllHealthGoalsCompleted();
  }

  checkAllHealthGoalsCompleted(): void {
    let allCompleted = true;
    let completedCount = 0;

    for (let i = 0; i < this.healthReminderItems.length; i++) {
      if (this.healthReminderItems[i].selected) {
        completedCount = completedCount + 1;
      } else {
        allCompleted = false;
      }
    }

    const today = new Date().setHours(0, 0, 0, 0);

    if (allCompleted) {
      if (!this.hasCompletedToday && this.lastResetDate === today) {
        this.healthStreakDays = this.healthStreakDays + 1;
        this.hasCompletedToday = true;
        this.healthSuccessMessage = `å¤ªæ£’äº†ï¼ä½ å·²ç»è¿ç»­å¥åº·ç”Ÿæ´»${this.healthStreakDays}å¤©äº†ï¼`;
      } else if (this.hasCompletedToday) {
        this.healthSuccessMessage = 'ä»Šæ—¥å·²å®Œæˆå¥åº·æ‰“å¡ï¼';
      }

      setTimeout(() => {
        this.healthSuccessMessage = '';
      }, 3000);
    }
  }

  resetHealthGoals(): void {
    const today = new Date().setHours(0, 0, 0, 0);

    if (this.lastResetDate < today) {
      const newItems: HealthReminderItem[] = [];
      for (let i = 0; i < this.healthReminderItems.length; i++) {
        const newItem: HealthReminderItem = {
          id: this.healthReminderItems[i].id,
          name: this.healthReminderItems[i].name,
          description: this.healthReminderItems[i].description,
          selected: false,
          uiSelected: false
        };
        newItems.push(newItem);
      }

      this.healthReminderItems = newItems;
      this.lastResetDate = today;
      this.hasCompletedToday = false;
      this.healthForceUpdateKey = this.healthForceUpdateKey + 1;

      if (this.healthResetTimer) {
        clearTimeout(this.healthResetTimer);
      }
      this.setupHealthResetTimer();
    }
  }

  setupHealthResetTimer(): void {
    const now = new Date();
    const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
    const timeUntilMidnight = tomorrow.getTime() - now.getTime();

    this.healthResetTimer = setTimeout(() => {
      this.resetHealthGoals();
    }, timeUntilMidnight);
  }

  reorderTodos(): void {
    const reorderedTodos: TodoItem[] = [];
    for (let i = 0; i < this.todos.length; i++) {
      const reorderedTodo: TodoItem = {
        id: this.todos[i].id,
        text: this.todos[i].text,
        completed: this.todos[i].completed,
        priority: this.todos[i].priority,
        order: i + 1,
        createdAt: this.todos[i].createdAt,
        completedAt: this.todos[i].completedAt
      };
      reorderedTodos.push(reorderedTodo);
    }
    this.todos = reorderedTodos;
  }

  sortTodos(): void {
    this.todos.sort((a: TodoItem, b: TodoItem) => {
      if (a.completed && !b.completed) return 1;
      if (!a.completed && b.completed) return -1;

      if (!a.completed && !b.completed) {
        if (a.priority !== b.priority) return a.priority - b.priority;
        return a.createdAt - b.createdAt;
      }

      if (a.completed && b.completed) {
        if (a.priority !== b.priority) return a.priority - b.priority;
        return b.completedAt - a.completedAt;
      }

      return 0;
    });
    this.reorderTodos();
  }

  handleDragStart(index: number): void {
    this.draggingIndex = index;
  }

  handleDragEnter(index: number): void {
    if (this.draggingIndex !== -1 && this.draggingIndex !== index) {
      this.hoverIndex = index;
    }
  }

  handleDragLeave(): void {
    this.hoverIndex = -1;
  }

  handleDragEnd(): void {
    if (this.draggingIndex !== -1 && this.hoverIndex !== -1) {
      const dragged = this.todos.splice(this.draggingIndex, 1)[0];
      this.todos.splice(this.hoverIndex, 0, dragged);
      this.reorderTodos();
      this.todosForceUpdateKey = this.todosForceUpdateKey + 1;
    }
    this.draggingIndex = -1;
    this.hoverIndex = -1;
  }

  getCompletedHealthCount(): number {
    let count = 0;
    for (let i = 0; i < this.healthReminderItems.length; i++) {
      if (this.healthReminderItems[i].selected) {
        count = count + 1;
      }
    }
    return count;
  }

  getDisplayedTodos(): TodoItem[] {
    switch (this.currentView) {
      case 'completed':
        const completedTodos: TodoItem[] = [];
        for (let i = 0; i < this.todos.length; i++) {
          if (this.todos[i].completed) {
            completedTodos.push(this.todos[i]);
          }
        }
        return completedTodos;
      case 'uncompleted':
        const uncompletedTodos: TodoItem[] = [];
        for (let i = 0; i < this.todos.length; i++) {
          if (!this.todos[i].completed) {
            uncompletedTodos.push(this.todos[i]);
          }
        }
        return uncompletedTodos;
      default:
        return this.todos;
    }
  }

  getCompletedCount(): number {
    let count = 0;
    for (let i = 0; i < this.todos.length; i++) {
      if (this.todos[i].completed) {
        count = count + 1;
      }
    }
    return count;
  }

  getUncompletedCount(): number {
    let count = 0;
    for (let i = 0; i < this.todos.length; i++) {
      if (!this.todos[i].completed) {
        count = count + 1;
      }
    }
    return count;
  }

  getRandomMotivationalMessage(): string {
    const randomIndex = Math.floor(Math.random() * this.motivationalMessages.length);
    return this.motivationalMessages[randomIndex];
  }

  getMotivationalMessage(): string {
    const completed = this.getCompletedCount();
    const total = this.todos.length;

    if (total === 0) return 'å¼€å§‹ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼';
    if (completed === total) return 'å¤ªæ£’äº†ï¼æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†ï¼';

    const percentage = (completed / total) * 100;
    if (percentage >= 80) return this.getRandomMotivationalMessage();
    if (percentage >= 50) return 'å·²ç»å®Œæˆä¸€åŠäº†ï¼Œç»§ç»­åŠªåŠ›ï¼';
    if (percentage >= 20) return 'è‰¯å¥½çš„å¼€å§‹ï¼ŒåšæŒä¸‹å»ï¼';
    return 'è¿ˆå‡ºç¬¬ä¸€æ­¥å¾ˆé‡è¦ï¼ŒåŠ æ²¹ï¼';
  }

  setEmptyStateMotivation(): void {
    if (this.currentView === 'uncompleted' && this.getUncompletedCount() === 0) {
      this.emptyStateMotivation = 'å¤ªæ£’äº†ï¼æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œç»§ç»­ä¿æŒè¿™ç§ä¸“æ³¨åŠ›ï¼';
    } else if (this.currentView === 'completed' && this.getCompletedCount() === 0) {
      this.emptyStateMotivation = 'å¼€å§‹è¡ŒåŠ¨å§ï¼æ¯å®Œæˆä¸€ä¸ªå°ä»»åŠ¡éƒ½æ˜¯å‘ç›®æ ‡è¿ˆè¿›çš„ä¸€æ­¥ï¼';
    } else {
      this.emptyStateMotivation = this.getRandomMotivationalMessage();
    }
  }

  aboutToAppear() {
    this.initializePersistentStorage();
    this.resetHealthGoals();
    this.setupHealthResetTimer();
  }

  aboutToDisappear() {
    if (this.healthResetTimer) {
      clearTimeout(this.healthResetTimer);
    }
  }

  // åˆå§‹åŒ–æŒä¹…åŒ–å­˜å‚¨
  private initializePersistentStorage(): void {
    console.log('=== åˆå§‹åŒ–æŒä¹…åŒ–å­˜å‚¨ ===');

    // å¦‚æœå­˜å‚¨ä¸­è¿˜æ²¡æœ‰æ•°æ®ï¼Œè®¾ç½®é»˜è®¤å€¼
    if (this.todos.length === 0) {
      const defaultTodos: TodoItem[] = [
        {
          id: 1,
          text: 'å®Œæˆé¡¹ç›®æŠ¥å‘Š',
          completed: false,
          priority: 1,
          order: 1,
          createdAt: Date.now() - 86400000,
          completedAt: 0
        },
        {
          id: 2,
          text: 'è´­ä¹°ç”Ÿæ´»ç”¨å“',
          completed: false,
          priority: 2,
          order: 2,
          createdAt: Date.now() - 43200000,
          completedAt: 0
        },
        {
          id: 3,
          text: 'é˜…è¯»30åˆ†é’Ÿ',
          completed: true,
          priority: 3,
          order: 3,
          createdAt: Date.now() - 21600000,
          completedAt: Date.now() - 10800000
        }
      ];
      this.todos = defaultTodos;
    }

    if (this.healthReminderItems.length === 0) {
      const defaultHealthItems: HealthReminderItem[] = [
        { id: 1, name: 'å–æ°´', description: 'æ¯å¤©8æ¯æ°´', selected: false, uiSelected: false },
        { id: 2, name: 'è¿åŠ¨', description: 'è¿åŠ¨èµ·æ¥', selected: false, uiSelected: false },
        { id: 3, name: 'é¥®é£Ÿ', description: 'å‡è¡¡é¥®é£Ÿ', selected: false, uiSelected: false },
        { id: 4, name: 'ä¼‘æ¯', description: 'å……è¶³ç¡çœ ', selected: false, uiSelected: false },
        { id: 5, name: 'å­¦ä¹ ', description: 'å­¦ä¹ 1å°æ—¶', selected: false, uiSelected: false }
      ];
      this.healthReminderItems = defaultHealthItems;
    }

    console.log('æŒä¹…åŒ–å­˜å‚¨åˆå§‹åŒ–å®Œæˆ');
  }

  build() {
    Column({ space: 20 }) {
      // å¥åº·ç›®æ ‡åŒºåŸŸ
      Column({ space: 15 }) {
        Row({ space: 10 }) {
          Text('ä»Šæ—¥å¥åº·ç›®æ ‡')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')

          Text(`(${this.getCompletedHealthCount()}/${this.healthReminderItems.length})`)
            .fontSize(16)
            .fontColor('#666')
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .padding({ left: 20 })

        if (this.healthSuccessMessage !== '') {
          Text(this.healthSuccessMessage)
            .fontSize(16)
            .fontColor('#4CAF50')
            .margin({ top: 5, bottom: 5 })
            .width('100%')
            .textAlign(TextAlign.Center)
        }

        Row({ space: 10 }) {
          Button('ä¸€é”®å®Œæˆ')
            .width(120)
            .height(40)
            .fontColor(Color.White)
            .backgroundColor('#2196F3')
            .onClick(() => {
              this.toggleAllHealthReminders();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 10 })

        // å¥åº·ç›®æ ‡åˆ—è¡¨
        Scroll() {
          Row({ space: 15 }) {
            ForEach(
              this.healthReminderItems,
              (reminder: HealthReminderItem, index: number) => {
                Column({ space: 8 }) {
                  Column() {
                    Image(this.getImageResource(reminder.name))
                      .width(35)
                      .height(35)
                      .objectFit(ImageFit.Contain)
                      .opacity(reminder.uiSelected ? 1.0 : 0.6)
                  }
                  .width(40)
                  .height(40)
                  .backgroundColor(reminder.uiSelected ? '#4CAF50' : '#E0E0E0')
                  .borderRadius(22.5)
                  .margin({ bottom: 3 })

                  Circle({ width: 8, height: 8 })
                    .fill(reminder.uiSelected ? '#4CAF50' : '#FF9800')
                    .margin({ bottom: 3 })

                  Button(reminder.uiSelected ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ')
                    .width(75)
                    .height(30)
                    .fontSize(11)
                    .fontColor(Color.White)
                    .backgroundColor(reminder.uiSelected ? '#4CAF50' : '#FF9800')
                    .onClick(() => {
                      this.toggleHealthReminderItem(index);
                    })

                  Text(reminder.name)
                    .fontSize(13)
                    .fontColor('#333')
                    .fontWeight(FontWeight.Medium)
                    .maxLines(1)

                  Text(reminder.description)
                    .fontSize(10)
                    .fontColor('#999')
                    .maxLines(1)

                  if (reminder.uiSelected) {
                    Text('å·²å®Œæˆ')
                      .fontSize(9)
                      .fontColor('#4CAF50')
                      .fontWeight(FontWeight.Bold)
                      .backgroundColor('#E8F5E8')
                      .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                      .borderRadius(3)
                      .margin({ top: 2 })
                  } else {
                    Text('æœªå®Œæˆ')
                      .fontSize(9)
                      .fontColor('#FF9800')
                      .fontWeight(FontWeight.Bold)
                      .backgroundColor('#FFF3E0')
                      .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                      .borderRadius(3)
                      .margin({ top: 2 })
                  }
                }
                .width(85)
                .height(150)
                .padding(8)
                .backgroundColor(reminder.uiSelected ? '#E8F5E8' : '#FFFFFF')
                .borderRadius(12)
                .shadow({ radius: 2, color: reminder.uiSelected ? '#4CAF50' : '#DDD', offsetX: 0, offsetY: 1 })
              },
              (reminder: HealthReminderItem) => `${reminder.id}_${this.healthForceUpdateKey}`
            )
          }
          .padding({ left: 20, right: 20 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .height(170)
      }
      .width('100%')
      .padding({ top: 15, bottom: 15 })
      .backgroundColor('#FFFFFF')
      .borderRadius(20)
      .margin({ left: 15, right: 15 })

      // å¾…åŠäº‹é¡¹åŒºåŸŸ
      Column({ space: 15 }) {
        Row({ space: 10 }) {
          Text('æˆ‘çš„å¾…åŠäº‹é¡¹')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')

          Text(this.getMotivationalMessage())
            .fontSize(14)
            .fontColor('#FF6B6B')
            .layoutWeight(1)
            .textAlign(TextAlign.End)
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)

        Column({ space: 10 }) {
          Row({ space: 10 }) {
            TextInput({ text: this.newTodoText, placeholder: 'è¾“å…¥æ–°ä»»åŠ¡...' })
              .onChange((value: string) => {
                this.newTodoText = value;
              })
              .layoutWeight(1)
              .height(45)
              .backgroundColor(Color.White)
              .borderRadius(10)
              .padding(10)

            Button('æ·»åŠ ')
              .width(80)
              .height(45)
              .fontColor(Color.White)
              .backgroundColor('#ff395fc1')
              .onClick(() => {
                this.addTodo();
              })
          }

          Row({ space: 10 }) {
            Text('ä¼˜å…ˆçº§:')
              .fontSize(16)
              .fontColor('#666')

            ForEach(
              [1, 2, 3],
              (priority: number) => {
                Button(this.getPriorityText(priority))
                  .width(60)
                  .height(35)
                  .fontSize(14)
                  .backgroundColor(this.newTodoPriority === priority ? this.getPriorityColor(priority) : '#F0F0F0')
                  .fontColor(this.newTodoPriority === priority ? Color.White : '#666')
                  .onClick(() => {
                    this.newTodoPriority = priority;
                  })
              },
              (priority: number) => priority.toString()
            )
          }
        }
        .padding(15)
        .backgroundColor('#F8F9FA')
        .borderRadius(12)

        Row({ space: 10 }) {
          Button('æ€»ä»»åŠ¡')
            .layoutWeight(1)
            .height(40)
            .backgroundColor(this.currentView === 'all' ? '#2196F3' : '#F0F0F0')
            .fontColor(this.currentView === 'all' ? Color.White : '#666')
            .onClick(() => {
              this.currentView = 'all';
              this.sortTodos();
              this.todosForceUpdateKey = this.todosForceUpdateKey + 1;
            })

          Button(`æœªå®Œæˆ (${this.getUncompletedCount()})`)
            .layoutWeight(1)
            .height(40)
            .backgroundColor(this.currentView === 'uncompleted' ? '#4CAF50' : '#F0F0F0')
            .fontColor(this.currentView === 'uncompleted' ? Color.White : '#666')
            .onClick(() => {
              this.currentView = 'uncompleted';
              this.sortTodos();
              this.setEmptyStateMotivation();
              this.todosForceUpdateKey = this.todosForceUpdateKey + 1;
            })

          Button(`å·²å®Œæˆ (${this.getCompletedCount()})`)
            .layoutWeight(1)
            .height(40)
            .backgroundColor(this.currentView === 'completed' ? '#FFA726' : '#F0F0F0')
            .fontColor(this.currentView === 'completed' ? Color.White : '#666')
            .onClick(() => {
              this.currentView = 'completed';
              this.sortTodos();
              this.setEmptyStateMotivation();
              this.todosForceUpdateKey = this.todosForceUpdateKey + 1;
            })
        }

        if (this.getDisplayedTodos().length === 0) {
          Column() {
            if (this.currentView === 'all') {
              Column() {
                Text('ğŸ“„').fontSize(60)
              }
              .width(120)
              .height(120)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .margin({ bottom: 20 })
              Text('æš‚æ— å¾…åŠäº‹é¡¹').fontSize(18).fontColor('#999')
              Text('æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼').fontSize(14).fontColor('#CCC').margin({ top: 5 })
              Text(this.getRandomMotivationalMessage())
                .fontSize(14)
                .fontColor('#FF6B6B')
                .margin({ top: 10 })
            } else if (this.currentView === 'uncompleted') {
              Column() {
                Column() {
                  Column() {
                    Text('ğŸ‰').fontSize(60)
                  }
                  .width(120)
                  .height(120)
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .margin({ bottom: 20 })

                  Text('æš‚æ— æœªå®Œæˆä»»åŠ¡').fontSize(18).fontColor('#4CAF50')
                  Text('å¤ªæ£’äº†ï¼æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†ï¼').fontSize(14).fontColor('#999').margin({ top: 5 })
                }
                .layoutWeight(1)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)

                Column() {
                  Blank().height(20)
                  Text(this.emptyStateMotivation || 'å¤ªæ£’äº†ï¼æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œç»§ç»­ä¿æŒè¿™ç§ä¸“æ³¨åŠ›ï¼')
                    .fontSize(16)
                    .fontColor('#4CAF50')
                    .fontWeight(FontWeight.Medium)
                    .textAlign(TextAlign.Center)
                    .width('100%')
                }
                .width('100%')
                .alignItems(HorizontalAlign.Center)
              }
              .width('100%')
              .flexGrow(1)
              .justifyContent(FlexAlign.SpaceBetween)

            } else {
              Column() {
                Column() {
                  Column() {
                    Text('ğŸ“‹').fontSize(60)
                  }
                  .width(120)
                  .height(120)
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .margin({ bottom: 20 })

                  Text('æš‚æ— å·²å®Œæˆä»»åŠ¡').fontSize(18).fontColor('#999')
                  Text('å¼€å§‹å®Œæˆä»»åŠ¡å§ï¼').fontSize(14).fontColor('#CCC').margin({ top: 5 })
                }
                .layoutWeight(1)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)

                Column() {
                  Blank().height(20)
                  Text(this.emptyStateMotivation || 'å¼€å§‹è¡ŒåŠ¨å§ï¼æ¯å®Œæˆä¸€ä¸ªå°ä»»åŠ¡éƒ½æ˜¯å‘ç›®æ ‡è¿ˆè¿›çš„ä¸€æ­¥ï¼')
                    .fontSize(16)
                    .fontColor('#FF6B6B')
                    .fontWeight(FontWeight.Medium)
                    .textAlign(TextAlign.Center)
                    .width('100%')
                }
                .width('100%')
                .alignItems(HorizontalAlign.Center)
              }
              .width('100%')
              .flexGrow(1)
              .justifyContent(FlexAlign.SpaceBetween)
            }
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.SpaceBetween)
        } else {
          Scroll() {
            Column({ space: 10 }) {
              ForEach(
                this.getDisplayedTodos(),
                (item: TodoItem) => {
                  Column() {
                    Row({ space: 12 }) {
                      Column() {
                        Text('â‹®â‹®').fontSize(16).fontColor('#CCC').opacity(0.7)
                      }
                      .width(30)
                      .height('100%')
                      .justifyContent(FlexAlign.Center)
                      .onTouch((event: TouchEvent) => {
                        const realIndex = this.todos.findIndex(t => t.id === item.id);
                        if (event.type === TouchType.Down) this.handleDragStart(realIndex);
                        if (event.type === TouchType.Up) this.handleDragEnd();
                      })

                      Column() {
                        Image(item.completed ? $r('app.media.complete') : $r('app.media.empty'))
                          .width(20)
                          .height(20)
                      }
                      .width(30)
                      .height(30)
                      .justifyContent(FlexAlign.Center)
                      .alignItems(HorizontalAlign.Center)
                      .onClick(() => {
                        this.toggleComplete(item.id);
                      })

                      Column({ space: 4 }) {
                        Text(item.text)
                          .fontSize(16)
                          .fontColor(item.completed ? '#AAA' : '#333')
                          .decoration({
                            type: item.completed ? TextDecorationType.LineThrough : TextDecorationType.None
                          })

                        Row({ space: 4 }) {
                          Circle({ width: 8, height: 8 }).fill(this.getPriorityColor(item.priority))
                          Text(this.getPriorityText(item.priority) + 'ä¼˜å…ˆçº§')
                            .fontSize(12)
                            .fontColor(this.getPriorityColor(item.priority))
                        }
                      }
                      .layoutWeight(1)

                      Stack() {
                        Column()
                          .width(30)
                          .height(30)
                          .backgroundColor('#FF6B6B')
                          .borderRadius(5)

                        Text('Ã—')
                          .fontSize(20)
                          .fontColor(Color.White)
                          .fontWeight(FontWeight.Bold)
                          .width('100%')
                          .height('100%')
                          .textAlign(TextAlign.Center)
                      }
                      .width(30)
                      .height(30)
                      .onClick(() => this.deleteTodo(item.id))
                    }
                    .width('100%')
                    .height(70)
                    .padding({ left: 10, right: 10 })
                    .backgroundColor(Color.White)
                    .borderRadius(10)
                    .shadow({ radius: 2, color: '#EEE', offsetX: 0, offsetY: 2 })
                    .onTouch((event: TouchEvent) => {
                      const realIndex = this.todos.findIndex(t => t.id === item.id);
                      if (event.type === TouchType.Move) this.handleDragEnter(realIndex);
                      if (event.type === TouchType.Up) this.handleDragLeave();
                    })
                  }
                  .margin({ bottom: 10 })
                  .border({
                    width: this.hoverIndex === this.todos.findIndex(t => t.id === item.id) ? 2 : 0,
                    color: '#2196F3',
                    style: BorderStyle.Dashed
                  })
                  .borderRadius(10)
                },
                (item: TodoItem) => `${item.id}_${this.todosForceUpdateKey}`
              )
            }
            .padding(10)
          }
          .scrollable(ScrollDirection.Vertical)
          .layoutWeight(1)
        }
      }
      .layoutWeight(1)
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 20, topRight: 20 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F0F2F5')
  }
}
